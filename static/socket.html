<!-- ë‹¤ë¥¸ í¬íŠ¸ì—ì„œ ì—´ì–´ì•¼ í•¨ -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Room Test</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #messages {
            list-style-type: none;
            padding: 0;
        }

        /* ê° ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 10px;
            max-width: 60%;
            word-wrap: break-word;
        }

        /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½ ì •ë ¬) */
        .my-message {
            background-color: #c2ebcd;
            color: #000000; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            margin-left: auto;
            text-align: right;
        }

        /* ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ (ì™¼ìª½ ì •ë ¬) */
        .other-message {
            background-color: #d6d6d6;
            color: #000000; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            margin-right: auto;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>WebSocket Room Test</h1>

    <!-- ë¡œê·¸ì¸ ì˜ì—­ -->
    <div id="login-section">
        <input type="text" id="username" placeholder="Enter username">
        <input type="password" id="password" placeholder="Enter password">
        <button onclick="login()">Login</button>
    </div>

    <!-- ì•¡ì„¸ìŠ¤ í† í° ì…ë ¥ ë° ì¸ì¦ -->
    <div id="token-section" style="display: none;">
        <h3>Enter Access Token:</h3>
        <input type="text" id="accessTokenInput" placeholder="Paste Access Token">
        <button onclick="authenticateWithToken()">Authenticate</button>
    </div>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <div id="chat-section" style="display: none;">
        <h2>Chat Room</h2>
        <p>Room: <span id="room-name">Not Joined</span></p>
        <input type="text" id="message" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
        <ul id="messages"></ul>
    </div>

    <script>
        const socket = io('http://localhost:3000/socket'); // WebSocket ìë™ ì—°ê²°
        let accessToken = null;

        socket.on('connect', () => {
            console.log('âœ… Connected to WebSocket server');
        });

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            fetch('http://localhost:3000/auth/signin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.accessToken) {
                    console.log("ğŸ”‘ Access Token:", data.accessToken); // ì½˜ì†”ì— í† í° ì¶œë ¥
                    alert("Access Tokenì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById("login-section").style.display = "none";
                    document.getElementById("token-section").style.display = "block";
                } else {
                    alert('Login failed!');
                }
            })
            .catch(error => {
                console.error('Login error:', error);
                alert('Error logging in');
            });
        }

        function authenticateWithToken() {
            accessToken = document.getElementById("accessTokenInput").value;
            if (!accessToken) {
                alert("Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            socket.emit('authenticate', { token: accessToken }); //ì„œë²„ë¡œ authenticateì´ë²¤íŠ¸ ì „ì†¡
        }

        socket.on('authenticated', (roomName) => {
            document.getElementById('room-name').innerText = roomName;
            document.getElementById("token-section").style.display = "none";
            document.getElementById("chat-section").style.display = "block";
            console.log(`âœ… Authenticated and joined room: ${roomName}`);
        });

        socket.on('message', (data) => {
            const li = document.createElement('li');
            li.classList.add('message', 'other-message'); 
            li.textContent = `${data.user}: ${data.message}`;

            document.getElementById('messages').prepend(li);
        });

        function sendMessage() {
            const message = document.getElementById('message').value;
            if (!message) return;

            socket.emit('message', { message, user: 'me' });  // 'me'ëŠ” ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë¡œ í‘œì‹œ

            const li = document.createElement('li');
            li.classList.add('message', 'my-message');  // 'my-message'ë¡œ ìŠ¤íƒ€ì¼ ì ìš© (ë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼)
            li.textContent = `me: ${message}`;  // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
            document.getElementById('messages').prepend(li);  // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€

            document.getElementById('message').value = '';
        }
    </script>
</body>
</html>
